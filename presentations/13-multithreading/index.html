<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Multithreading</title>
    <meta name="description" content="Multithreading in C#">
    <meta name="author" content="Valentine Radchuk">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="//code.jquery.com/jquery-1.8.0.js"></script>
    <script src="//code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../shared/css/reveal.css">
    <link rel="stylesheet" href="../../shared/css/theme/league.css" id="theme">
    <link type="text/css" rel="stylesheet" href="../../shared/fsharp.formatting/styles/style.css" />
    <link type="text/css" rel="stylesheet" href="../../shared/fsharp.formatting/styles/deedle.css" />
    <link type="text/css" rel="stylesheet" href="../../shared/css/custom.css" />
    <script src="../../shared/fsharp.formatting/styles/tips.js" type="text/javascript"></script>
    <link rel="shortcut icon" type="image/png" href="../../shared/favicon.png">
    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="../../shared/lib/css/zenburn.css">
    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = '../../shared/css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
    </script>
    <!--[if lt IE 9]>
    <script src="../../shared/lib/js/html5shiv.js"></script>
    <![endif]-->
</head>
<body>
    <div class="reveal">
        
        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">
            <section >

<h2>C# course</h2>

<h4>Lecture 13</h4>

<h1>Multithreading in C#</h1>

</section>

<section >

<h2>Agenda</h2>

<ul>
<li>Introduction and Concepts</li>
<li>Threads</li>
<li>Creating and starting threads</li>
<li>Thread lifecycle</li>
<li>Error handling</li>
<li>Thread Pooling</li>
<li>Synchronization concepts</li>
<li>Immutable objects and synchronization</li>
</ul>

</section>

<section >

<section >

<h3>What is multithreading</h3>

<p>Multithreading - parallel execution of code, leveraging threads.</p>

<br/>

<p>C# enables multithreading using following namespace:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip" lang="cs"><span class="k">using</span> System.Threading; 
</pre></td></tr></table>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>When to parallel?</h3>

<p>When multithreading might be useful?</p>

<ul>
<li>there are few independent tasks that do not intersect (usually calculation)</li>
<li>separate heavy calculation from UI (to avoid freezes)</li>
<li>constantly query external service and notify application if new data arrived</li>
<li>to avoid stop processing waiting for user's input</li>
<li>separating processing workflow by threads (collect - filter - process - save)</li>
</ul>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>When not to parallel?</h3>

<p>When multithreading might be awkward?</p>

<ul>
<li>when number of threads is big enought</li>
<li>when modules are tightly coupled and there are a lot of commmon data across modules (refactor first)</li>
<li>when it won't bring any value (switching threads is a heavy operation)</li>
</ul>

</section>

</section>

<section >

<section >

<h3>Thread</h3>

<ul>
<li>a <strong>thread</strong> is an independent execution path, able to run simultaneously with other threads and can be managed independently by a scheduler</li>
<li>threads might run in parallel on differen physical cores or creatign multicore illusion (preemptive or context switching)</li>
</ul>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Context switching</h3>

<p><img src="images/Context_switching.png" alt="Context switching" /></p>

</section>

</section>

<section >

<section >

<h3>Threads vs Processes</h3>

<p>Do not mix Threads and Processes</p>

<p><img src="images/WindowsTaskManager.png" alt="Task manager in Windows" /></p>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Thread vs Process - Processes</h3>

<p>Thread - execution path within a process</p>

<ul>
<li>contains running code</li>
<li>share memory of containing process</li>
<li>share resources dedicated for containing process</li>
<li>has own stack withing process memory</li>
<li>requiere synchronization</li>
</ul>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Thread vs Process - Threads</h3>

<p>Process - is an instance of a program</p>

<ul>
<li>each process has own dedicated memory space</li>
<li>contains at least 1 thread</li>
<li>few processes might represent the same program</li>
<li>syncronization almost not required</li>
</ul>

<br />

<a href="https://dotnetfiddle.net/zDZ1V2">Example of code with multiple threads</a>

</section>

</section>

<section >

<section >

<h3>Threads in C#</h3>

<p>Threads are represented in C# by class <a href="https://msdn.microsoft.com/en-us/library/system.threading.thread%28v=vs.110%29.aspx">Thread</a></p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip" lang="cs">    System.Threading.Thread
</pre></td></tr></table>

<h4>Constructors:</h4>

<p>Run parameterless method in separate thread</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip" lang="cs">    Thread(ThreadStart)
</pre></td></tr></table>

<p>Run method with an object-type parameter in separate thread</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip" lang="cs">    Thread(ParameterizedThreadStart)
</pre></td></tr></table>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Creating and running threads</h3>

<p>Thread should be created with an entry point when new thread will start execution.</p>

<p>This entry point is outlined by following delegates:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip" lang="cs">    <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> ThreadStart();
    <span class="k">public</span> <span class="k">delegate</span> <span class="k">void</span> ParameterizedThreadStart(Object obj);
</pre></td></tr></table>

<p>Once thread created it should be run for execution:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip" lang="cs">    <span class="k">var</span> thread <span class="o">=</span> <span class="k">new</span> Thread(someEntryPoint);
    thread.Start();     
</pre></td></tr></table>

<a href="https://dotnetfiddle.net/zDZ1V2">Create thread - demo</a>

</section>

</section>

<section >

<section >

<h3>Thread lifecycle</h3>

<p><img src="images/threadStates.png" alt="Thread lifecycle" /></p>

<p><aside class="notes">
        Oh hey, these are some notes.
  </aside></p>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Thread lifecycle details</h3>

<p><img src="images\threadStates_details.png" alt="Thread states with descriptions" /></p>

<a href="http://www.codeproject.com/Articles/26675/Beginner-s-Guide-to-Threading-in-NET-Part-of-n">More about multithreading</a>

</section>

</section>

<section >

<h3>Stopping and aborting threads</h3>

<p>There are a number of ways to stop thread:</p>

<ul>
<li>Let thread exits by itself</li>
<li>Let thread dead by natural causes (exit from entry method)</li>
<li>Call <a href="https://msdn.microsoft.com/ru-ru/library/ty8d3wta(v=vs.110).aspx">Thread.Abort()</a> method (depricated)</li>
<li>Call <a href="https://msdn.microsoft.com/ru-ru/library/system.threading.thread.suspend(v=vs.110).aspx">Thread.Suspend()</a> method (depricated)</li>
<li>Call <a href="https://msdn.microsoft.com/ru-ru/library/system.threading.thread.interrupt(v=vs.110).aspx">Thread.Interrupt()</a> method to exit from SleepWaitJoin state</li>
</ul>

</section>

<section >

<h3>Thread characteristics</h3>

<ul>
<li><a href="http://www.c-sharpcorner.com/uploadfile/40e97e/what-is-foreground-or-background-thread/">background vs foreground threads (IsBackground)</a></li>
<li>thread could be named with property Name - <a href="http://www.codeproject.com/KB/cs/MasteringInDebugging/debug43_small.png">example</a></li>
<li>thread execution priority (<a href="https://msdn.microsoft.com/ru-ru/library/system.threading.thread.priority(v=vs.110).aspx">Priority</a>)</li>
<li>state of a thread (<a href="https://msdn.microsoft.com/ru-ru/library/system.threading.thread.threadstate(v=vs.110).aspx">ThreadState</a>)</li>
</ul>

</section>

<section >

<h3>Error handling</h3>

<ul>
<li>exception could be cought within a thread (not outside it)</li>
<li>unhandled exception occured at any thread terminates entire application</li>
<li>it does not make sense to catch ThreadAbortException (caused by Thread.Abort() method)</li>
<li>you can catch globally unhandled exception by event <a href="https://msdn.microsoft.com/en-us/library/system.appdomain.unhandledexception%28v=vs.110%29.aspx">AppDomain.CurrentDomain.UnhandledException</a>, however it's impossible to prevent application from closing</li>
</ul>

</section>

<section >

<section >

<h3>Thread pooling</h3>

<p>Creating thread consumes is an expensive operation. Thread pool cuts these overheads.</p>

<h4>Ways to enter the thread pool:</h4>

<ul>
<li>via the <a href="http://www.codeproject.com/Articles/152765/Task-Parallel-Library-of-n">Task Parallel Library</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/system.threading.threadpool.queueuserworkitem(v=vs.110).aspx">ThreadPool.QueueUserWorkItem</a> - <a href="https://dotnetfiddle.net/4ea3Ss">example</a></li>
<li>via <a href="http://www.codeproject.com/Articles/426120/Calling-a-method-in-Csharp-asynchronously-using-de">asynchronous delegates </a></li>
<li>via <a href="https://msdn.microsoft.com/en-us/library/system.componentmodel.backgroundworker(v=vs.110).aspx">BackgroundWorker</a></li>
</ul>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Thread pooling - schema</h3>

<p><img src="images\ThreadPool.png" alt="Thread Pool" /></p>

</section>

</section>

<section >

<h3>Common synchronization problems</h3>

<ul>
<li><strong>atomicity</strong> - make critical code atomic</li>
<li><strong>visibility</strong> - if read/write operations are in diff threads, no guarantee that reading thread will read written value</li>
<li><strong>reordering</strong> - code order might be changed by CLR - this might be critical for app logic</li>
<li><strong>race condition</strong> - occurs when correctness of computation depends on data access time</li>
<li><strong>livelock</strong> - thread fails operation and returns data for re-processing</li>
<li><strong>starvation</strong> - mutual lock caused by inapropriate thread priorities</li>
<li><strong>deadlock</strong> - mutual lock of 2 or more threads

<aside class="notes">
      more details <a href="http://www.somanyword.com/2014/03/common-problems-of-concurrency-multi-threading-in-java/">here</a>
</aside></li>
</ul>

</section>

<section >

<section >

<h3>Synchronization primitives</h3>

<ul>
<li>Simple blocking methods</li>
<li>Locking constructs</li>
<li>Signaling constructs</li>
<li>Nonblocking synchronization constructs
<ul>
<li>volatile keyword</li>
<li>Interlocked class</li>
<li><h2>use immutable objects</h2>
<h3>Simple blocking methods</h3></li>
</ul></li>
<li>Sleep - pause thread execution for specified time</li>
<li>Join - invoking thread pauses until other thread finish its execution</li>
</ul>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Locking</h3>

<p>Exclusive locking is used to ensure that only one thread can enter particular sections of code at a time</p>

<ul>
<li>lock (Monitor.Enter \ Monitor.Exit) - <a href="https://dotnetfiddle.net/H6zPDU">lock example</a>, <a href="https://dotnetfiddle.net/wNooFx">Monitor example</a></li>
<li>mutex - <a href="https://dotnetfiddle.net/4X6s7i">example</a></li>
<li>semaphore - <a href="https://dotnetfiddle.net/S1Kg5T">example</a></li>
</ul>

</section>

<section author="Valentine Radchuk" description="Multithreading in C#" theme="league" title="Multithreading" transition="default">

<h3>Signaling</h3>

<ul>
<li>AutoResetEvent -<a href="https://dotnetfiddle.net/9Q1Ala">example</a></li>
<li>ManualResetEvent</li>
<li>CountdownEvent - <a href="https://dotnetfiddle.net/pG4hCf">example</a></li>
</ul>

</section>

</section>



        </div>
    </div>
    <script src="../../shared/lib/js/head.min.js"></script>
    <script src="../../shared/js/reveal.js"></script>
    <script>

        // Full list of configuration options available here:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,

            transition: 'default', // default/cube/page/concave/zoom/linear/fade/none

            // Parallax scrolling
            // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
            // parallaxBackgroundSize: '2100px 900px',

            // Optional libraries used to extend on reveal.js
            dependencies: [
                { src: '../../shared/lib/js/classList.js', condition: function () { return !document.body.classList; } },
                { src: '../../shared/plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
                { src: '../../shared/plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
                { src: '../../shared/plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } },
                { src: '../../shared/plugin/zoom-js/zoom.js', async: true, condition: function () { return !!document.body.classList; } },
                { src: '../../shared/plugin/notes/notes.js', async: true, condition: function () { return !!document.body.classList; } }
            ]
        });

    </script>
</body>
</html>

